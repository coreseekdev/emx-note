-- tmp-orphan.txt --
orphan content

-- tmp-linked.txt --
linked content

-- tmp-withlink.txt --
See [[linked-note]] for more

# Test GC command
env EMX_NOTE_HOME=$WORK/.emx-notes
env EMX_AGENT_NAME=

# Create a capsa first
exec emx-note --home $WORK/.emx-notes -g capsa create test-gc
stdout 'Created capsa: test-gc'

# Create notes by piping from files
exec emx-note --home $WORK/.emx-notes -c test-gc note orphan-note < $WORK/tmp-orphan.txt
exec emx-note --home $WORK/.emx-notes -c test-gc note linked-note < $WORK/tmp-linked.txt
exec emx-note --home $WORK/.emx-notes -c test-gc note note-with-link < $WORK/tmp-withlink.txt

# Run GC in dry-run mode (should not delete)
exec emx-note --home $WORK/.emx-notes -c test-gc gc --days 0
stdout 'orphan-note'
stdout 'note-with-link'
stdout 'Dry-run'

# Verify files still exist (dry-run doesn't delete)
exists $WORK/.emx-notes/test-gc/note/orphan-note.md
exists $WORK/.emx-notes/test-gc/note/linked-note.md
exists $WORK/.emx-notes/test-gc/note/note-with-link.md

# Run GC with execute and force (skip confirmation)
# Should delete: orphan-note.md (no links), note-with-link.md (no incoming links)
# Should keep: linked-note.md (has incoming link from note-with-link.md)
exec emx-note --home $WORK/.emx-notes -c test-gc gc --days 0 --execute --force
stdout 'Deleted'

# Verify orphan and note-with-link are deleted but linked-note still exists
! exists $WORK/.emx-notes/test-gc/note/orphan-note.md
! exists $WORK/.emx-notes/test-gc/note/note-with-link.md
exists $WORK/.emx-notes/test-gc/note/linked-note.md
